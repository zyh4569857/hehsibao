<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭沟通调解报告 - 和事宝</title>
    <link rel="stylesheet" href="styles.css">
    <!-- 添加 jsPDF 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <h1>家庭沟通调解报告</h1>
            <p id="reportTimestamp"></p>
        </div>
        <div class="report-content">
            <div id="reportContent" class="report-text"></div>
        </div>
        <div class="report-actions">
            <button onclick="downloadPDF()" class="download-button">下载报告</button>
            <button onclick="window.print()" class="print-button">打印报告</button>
            <button onclick="window.location.href='chat.html'" class="back-button">返回对话</button>
        </div>
    </div>

    <script>
        // 从 URL 参数获取报告数据
        const urlParams = new URLSearchParams(window.location.search);
        const reportData = JSON.parse(decodeURIComponent(urlParams.get('data')));

        // 更新时间戳
        document.getElementById('reportTimestamp').textContent = `生成时间：${reportData.timestamp}`;

        // 显示报告内容
        const reportContent = document.getElementById('reportContent');
        reportContent.innerHTML = reportData.content.replace(/\n/g, '<br>');

        // 下载PDF报告
        async function downloadPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // 添加中文字体支持
                try {
                    doc.addFont('https://cdn.jsdelivr.net/npm/noto-sans-sc@1.0.1/NotoSansSC-Regular.otf', 'NotoSansSC', 'normal');
                    doc.setFont('NotoSansSC');
                } catch (fontError) {
                    console.warn('无法加载中文字体，将使用默认字体:', fontError);
                    // 使用默认字体继续
                }

                // 设置页面边距
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const contentWidth = pageWidth - 2 * margin;
                const footerHeight = 15; // 页脚高度

                // 添加页眉
                function addHeader() {
                    doc.setFontSize(10);
                    doc.text('和事宝 - 家庭沟通调解报告', margin, 10);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, 12, pageWidth - margin, 12);
                }

                // 添加页脚
                function addFooter(pageNumber, totalPages) {
                    doc.setFontSize(10);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, pageHeight - footerHeight, pageWidth - margin, pageHeight - footerHeight);
                    doc.text(`第 ${pageNumber} 页 / 共 ${totalPages} 页`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    doc.text(`和事宝 © ${new Date().getFullYear()}`, margin, pageHeight - 10);
                }

                // 处理报告内容
                doc.setFontSize(12);
                const content = reportData.content || '暂无报告内容';
                
                // 将内容按段落分割
                const paragraphs = content.split('\n');
                
                // 计算总页数（预估）
                let totalContentHeight = 0;
                let processedParagraphs = [];
                
                for (let para of paragraphs) {
                    // 处理每个段落，将其拆分成适合页面宽度的行
                    const lines = doc.splitTextToSize(para, contentWidth);
                    processedParagraphs.push(lines);
                    totalContentHeight += lines.length * 7; // 行高为7mm
                }
                
                // 估算总页数
                const contentAreaHeight = pageHeight - margin * 2 - footerHeight;
                const estimatedTotalPages = Math.ceil(totalContentHeight / contentAreaHeight) || 1;
                
                // 第一页需要显示标题和时间戳
                let currentPage = 1;
                let currentY = margin;
                
                // 添加第一页页眉
                addHeader();
                
                // 添加标题（仅第一页）
                doc.setFontSize(24);
                doc.text('家庭沟通调解报告', pageWidth / 2, currentY + 10, { align: 'center' });
                currentY += 15;
                
                // 添加时间戳（仅第一页）
                doc.setFontSize(12);
                doc.text(`生成时间：${reportData.timestamp}`, pageWidth / 2, currentY + 5, { align: 'center' });
                currentY += 15;
                
                // 设置正文字体大小
                doc.setFontSize(12);
                const lineHeight = 7;
                
                // 逐段添加内容
                for (let paragraph of processedParagraphs) {
                    // 检查当前段落是否需要分页
                    if (currentY + paragraph.length * lineHeight > pageHeight - footerHeight - margin) {
                        // 如果当前页剩余空间不足以容纳整个段落
                        
                        // 计算当前页还能容纳多少行
                        const remainingLines = Math.floor((pageHeight - footerHeight - margin - currentY) / lineHeight);
                        
                        // 如果至少能容纳一行，则先添加能容纳的行
                        if (remainingLines > 0) {
                            for (let i = 0; i < remainingLines; i++) {
                                doc.text(paragraph[i], margin, currentY);
                                currentY += lineHeight;
                            }
                            
                            // 添加当前页的页脚
                            addFooter(currentPage, estimatedTotalPages);
                            
                            // 添加新页
                            doc.addPage();
                            currentPage++;
                            currentY = margin + 20; // 新页的起始位置
                            
                            // 添加新页的页眉
                            addHeader();
                            
                            // 添加剩余的行到新页
                            for (let i = remainingLines; i < paragraph.length; i++) {
                                // 检查是否需要再次分页
                                if (currentY + lineHeight > pageHeight - footerHeight - margin) {
                                    // 添加当前页的页脚
                                    addFooter(currentPage, estimatedTotalPages);
                                    
                                    // 添加新页
                                    doc.addPage();
                                    currentPage++;
                                    currentY = margin + 20;
                                    
                                    // 添加新页的页眉
                                    addHeader();
                                }
                                
                                doc.text(paragraph[i], margin, currentY);
                                currentY += lineHeight;
                            }
                        } else {
                            // 如果一行都容纳不了，直接添加新页
                            addFooter(currentPage, estimatedTotalPages);
                            doc.addPage();
                            currentPage++;
                            currentY = margin + 20;
                            addHeader();
                            
                            // 在新页添加整个段落
                            for (let line of paragraph) {
                                // 检查是否需要再次分页
                                if (currentY + lineHeight > pageHeight - footerHeight - margin) {
                                    addFooter(currentPage, estimatedTotalPages);
                                    doc.addPage();
                                    currentPage++;
                                    currentY = margin + 20;
                                    addHeader();
                                }
                                
                                doc.text(line, margin, currentY);
                                currentY += lineHeight;
                            }
                        }
                    } else {
                        // 如果当前页能容纳整个段落，直接添加
                        for (let line of paragraph) {
                            doc.text(line, margin, currentY);
                            currentY += lineHeight;
                        }
                    }
                    
                    // 段落之间添加额外间距
                    currentY += lineHeight * 0.5;
                }
                
                // 添加最后一页的页脚
                addFooter(currentPage, estimatedTotalPages);
                
                // 保存PDF
                doc.save('家庭沟通调解报告.pdf');
                
                console.log(`成功生成PDF报告，共 ${currentPage} 页`);
            } catch (error) {
                console.error('生成PDF时发生错误:', error);
                alert('生成PDF时发生错误：' + error.message);
            }
        }
    </script>

    <style>
        .report-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1s ease-out;
            backdrop-filter: blur(10px);
        }

        .report-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .report-header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .report-content {
            margin-bottom: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .report-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #2c3e50;
        }

        .report-text h2 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .report-text h3 {
            font-size: 1.4rem;
            color: #34495e;
            margin: 1.5rem 0 1rem;
            padding-left: 1rem;
            border-left: 4px solid #3498db;
        }

        .report-text p {
            margin-bottom: 1rem;
        }

        .report-text ul, .report-text ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .report-text li {
            margin-bottom: 0.5rem;
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .download-button, .print-button, .back-button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .download-button {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .print-button {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
        }

        .back-button {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .download-button:hover, .print-button:hover, .back-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        @media print {
            .report-actions {
                display: none;
            }
            
            .report-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .report-text {
                font-size: 1rem;
            }
        }
    </style>
</body>
</html>