<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭沟通调解报告 - 和事宝</title>
    <!-- 添加html2canvas库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 添加jsPDF库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 添加中文字体支持 -->
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
    <!-- 添加思源黑体支持 -->
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"></script>
    <script src="https://cdn.jsdelivr.net/gh/sphilee/jsPDF-CustomFonts-support/dist/jspdf.customfonts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/sphilee/jsPDF-CustomFonts-support/dist/default_vfs.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", "SimSun", sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
        }
        .report-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .report-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }
        .report-header h1 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        .report-content {
            white-space: pre-wrap;
            line-height: 1.8;
            color: #2c3e50;
            padding: 0 1rem;
        }
        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 2rem;
            background: #fff3f3;
            border-radius: 10px;
            margin: 2rem 0;
        }
        .button-group {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .back-button {
            padding: 0.8rem 2rem;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .download-button {
            padding: 0.8rem 2rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .print-button {
            padding: 0.8rem 2rem;
            background: #2980b9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .back-button:hover, .download-button:hover, .print-button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        @media print {
            .button-group {
                display: none;
            }
            .report-container {
                margin: 0;
                padding: 1rem;
                box-shadow: none;
            }
        }
        .meta-info {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="report-container" id="reportContainer">
        <div class="report-header">
            <h1>家庭沟通调解报告</h1>
            <p id="reportTimestamp" class="meta-info"></p>
            <p id="reportRole" class="meta-info"></p>
        </div>
        <div class="report-content" id="reportContent">
            <!-- 报告内容将在这里显示 -->
        </div>
        <div class="button-group">
            <button onclick="window.location.href='chat.html'" class="back-button">返回对话</button>
            <button onclick="downloadPDF()" class="download-button">下载报告</button>
            <button onclick="window.print()" class="print-button">打印报告</button>
        </div>
    </div>

    <script>
        let reportData = null;

        // 获取并显示报告数据
        try {
            // 从 localStorage 获取数据
            const reportDataStr = localStorage.getItem('reportData');
            
            if (!reportDataStr) {
                throw new Error('未找到报告数据');
            }

            // 解析数据
            reportData = JSON.parse(reportDataStr);
            
            if (!reportData || !reportData.content) {
                throw new Error('报告数据无效');
            }

            // 显示时间戳和角色
            document.getElementById('reportTimestamp').textContent = `生成时间：${reportData.timestamp}`;
            document.getElementById('reportRole').textContent = `角色：${reportData.role === 'child' ? '孩子' : '父母'}`;
            
            // 显示报告内容
            document.getElementById('reportContent').textContent = reportData.content;

            // 清除 localStorage 中的报告数据
            localStorage.removeItem('reportData');

        } catch (error) {
            // 显示错误信息
            document.getElementById('reportContent').innerHTML = `
                <div class="error-message">
                    <h2>生成报告失败</h2>
                    <p>${error.message}</p>
                    <p>请返回对话页面重新生成报告。</p>
                </div>
            `;
        }

        // 下载PDF功能
        async function downloadPDF() {
            try {
                const container = document.getElementById('reportContainer');
                
                // 临时隐藏按钮组
                const buttonGroup = container.querySelector('.button-group');
                buttonGroup.style.display = 'none';
                
                // 使用html2canvas将内容转换为图片
                const canvas = await html2canvas(container, {
                    scale: 2, // 提高清晰度
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                // 恢复按钮组显示
                buttonGroup.style.display = 'flex';

                const { jsPDF } = window.jspdf;
                
                // 创建PDF文档
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: 'a4',
                    hotfixes: ['px_scaling']
                });

                // 获取PDF页面尺寸
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // 计算图片缩放比例
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
                
                // 计算居中位置
                const x = (pageWidth - imgWidth * ratio) / 2;
                const y = 20; // 顶部留出一些空间

                // 将canvas图片添加到PDF
                pdf.addImage(
                    canvas.toDataURL('image/jpeg', 1.0),
                    'JPEG',
                    x,
                    y,
                    imgWidth * ratio,
                    imgHeight * ratio,
                    undefined,
                    'FAST'
                );

                // 如果内容超过一页，添加新页面
                if (imgHeight * ratio > pageHeight) {
                    let remainingHeight = imgHeight * ratio;
                    let currentPage = 1;
                    
                    while (remainingHeight > pageHeight) {
                        pdf.addPage();
                        currentPage++;
                        remainingHeight -= pageHeight;
                        
                        pdf.addImage(
                            canvas.toDataURL('image/jpeg', 1.0),
                            'JPEG',
                            x,
                            y - pageHeight * (currentPage - 1),
                            imgWidth * ratio,
                            imgHeight * ratio,
                            undefined,
                            'FAST'
                        );
                    }
                }

                // 生成并下载PDF
                pdf.save('家庭沟通调解报告.pdf');

            } catch (error) {
                console.error('生成PDF错误:', error);
                alert('生成PDF失败，请尝试使用打印功能将页面另存为PDF文件。\n错误信息：' + error.message);
            }
        }
    </script>
</body>
</html>